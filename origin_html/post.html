
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>一个简单的api授权流程</title>
    <meta name="keywords" content="满江风雪, Heropoo, www.ioio.pw, ioio.pw, ioio, 博客, Heropoo的个人博客"/>
    <meta name="description" content="满江风雪，Heropoo的个人博客。
" />
    <link rel="stylesheet" href="/plugins/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

</head>
<body>

<div id="header" class="container">
    <div class="logo">
        <h1 class="text-logo">满江风雪</h1>
        <p class="text-line">One word then,one smile,is enough. </p>
    </div>
</div>
<div id="container" class="container">

    <div class="nav">
        <ul class="clearfix">
            <li><a href="/">首页</a></li>
            <li><a href="/about">关于我</a></li>
        </ul>
    </div>

    <div class="main clearfix">
        <div class="left-content fl">
            <h2 class="article-title">一个简单的api授权流程</h2>
            <div class="article-info">作者：Heropoo  时间：2017-08-16 10:42 </div>
            <div class="article-content">
                <p>实际项目中我们经常会碰到给第三方开放我们项目api的这种场景。这时我们要保证api的安全，参考<code class="highlighter-rouge">腾讯广点通</code>的api调用。现将php的代码实现整理这此。</p>

                <p>我们的算法很简单：</p>

                <blockquote>
                    <p>1.把调用方自己的appid,secret_key,当前的时间戳time连接起来用sha1方法生成一个sign</p>
                </blockquote>

                <blockquote>
                    <p>2.把appid,time,sign用英文逗号连接并用base64打包变成一个参数token</p>
                </blockquote>

                <p>###api的几个方法
                    <code class="highlighter-rouge">api_functions.php</code></p>
                <div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="sd">/**
 * 生成token
 * @param string $appid
 * @param string $secret_key
 * @param int $time
 * @return string
 */</span>
                    <span class="k">function</span> <span class="nf">generate_token</span><span class="p">(</span><span class="nv">$appid</span><span class="p">,</span> <span class="nv">$secret_key</span><span class="p">,</span> <span class="nv">$time</span><span class="p">)</span>
                    <span class="p">{</span>
                    <span class="nv">$sign</span> <span class="o">=</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$appid</span> <span class="o">.</span> <span class="nv">$secret_key</span> <span class="o">.</span> <span class="nv">$time</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$appid</span> <span class="o">.</span> <span class="s1">','</span> <span class="o">.</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s1">','</span> <span class="o">.</span> <span class="nv">$sign</span><span class="p">);</span>
                    <span class="p">}</span>

<span class="sd">/**
 * 解包token
 * @param string $token
 * @return array
 */</span>
                    <span class="k">function</span> <span class="nf">unpack_token</span><span class="p">(</span><span class="nv">$token</span><span class="p">){</span>
                    <span class="nv">$params</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>
                    <span class="nv">$params</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>

                    <span class="k">return</span> <span class="p">[</span>
                    <span class="s1">'appid'</span><span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
                    <span class="s1">'time'</span><span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
                    <span class="s1">'sign'</span><span class="o">=&gt;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
                    <span class="p">];</span>
                    <span class="p">}</span>

<span class="sd">/**
 * @param $url
 * @param array $data
 * @param bool $is_post
 * @param array $header
 * @return mixed
 */</span>
                    <span class="k">function</span> <span class="nf">sub_curl</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$is_post</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
                    <span class="p">{</span>
                    <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$is_post</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$url</span> <span class="o">.</span> <span class="s1">'?'</span> <span class="o">.</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_POST</span><span class="p">,</span> <span class="nv">$is_post</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$is_post</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_CONNECTTIMEOUT</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$header</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HTTPHEADER</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nv">$info</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
                    <span class="nv">$code</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_HTTP_CODE</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nv">$code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">){</span>

                    <span class="nx">echo_json</span><span class="p">(</span><span class="nv">$code</span><span class="p">,</span> <span class="s1">'api调用出错'</span><span class="o">.</span><span class="nv">$code</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nv">$info</span><span class="p">;</span>
                    <span class="p">}</span>

<span class="sd">/**
 * @param int $code
 * @param string $msg
 * @param array $data
 */</span>
                    <span class="k">function</span> <span class="nf">echo_json</span><span class="p">(</span><span class="nv">$code</span><span class="p">,</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">()){</span>
                    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-type:application/json'</span><span class="p">);</span>
                    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'ret'</span> <span class="o">=&gt;</span> <span class="nv">$code</span><span class="p">,</span> <span class="s1">'msg'</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="p">,</span> <span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">));</span>
                    <span class="k">exit</span><span class="p">;</span>
                    <span class="p">}</span>
                </code></pre>
                </div>

                <p>###api提供方
                    <code class="highlighter-rouge">api.php</code></p>
                <div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
                    <span class="k">require</span> <span class="s1">'api_functions.php'</span><span class="p">;</span>

<span class="c1">//授权的使用方名单 现为演示方便直接使用数组
</span><span class="nv">$users</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">'user_001'</span><span class="o">=&gt;</span><span class="p">[</span>
                    <span class="s1">'appid'</span><span class="o">=&gt;</span><span class="s1">'user_001'</span><span class="p">,</span>    <span class="c1">//使用方对于提供方api的唯一id
</span>        <span class="s1">'secret_key'</span><span class="o">=&gt;</span><span class="s1">'97bc847d4ea7dd9f035d41a657302f1c'</span>    <span class="c1">//密钥 也唯一
</span>    <span class="p">],</span>
                    <span class="s1">'user_002'</span><span class="o">=&gt;</span><span class="p">[</span>
                    <span class="s1">'appid'</span><span class="o">=&gt;</span><span class="s1">'user_002'</span><span class="p">,</span>
                    <span class="s1">'secret_key'</span><span class="o">=&gt;</span><span class="s1">'c763b64a62186ae6831edd22063539c4'</span>
                    <span class="p">],</span>
                    <span class="s1">'user_003'</span><span class="o">=&gt;</span><span class="p">[</span>
                    <span class="s1">'appid'</span><span class="o">=&gt;</span><span class="s1">'user_003'</span><span class="p">,</span>
                    <span class="s1">'secret_key'</span><span class="o">=&gt;</span><span class="s1">'51a683bea5e5c138fd0342fb70e03c65'</span>
                    <span class="p">],</span>
                    <span class="p">];</span>

<span class="c1">//检验签名
</span><span class="nv">$token</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'token'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'token'</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$token</span><span class="p">)){</span>
                    <span class="nx">echo_json</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">'token missed'</span><span class="p">);</span>
                    <span class="p">}</span>

<span class="c1">//解包token
</span><span class="nv">$token_params</span> <span class="o">=</span> <span class="nx">unpack_token</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>

                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$token_params</span><span class="p">[</span><span class="s1">'sign'</span><span class="p">])){</span>
                    <span class="nx">echo_json</span><span class="p">(</span><span class="mi">1001</span><span class="p">,</span> <span class="s1">'sign error'</span><span class="p">);</span>  <span class="c1">//签名为空或者错误
</span><span class="p">}</span>

                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$token_params</span><span class="p">[</span><span class="s1">'appid'</span><span class="p">])){</span>
                    <span class="nx">echo_json</span><span class="p">(</span><span class="mi">1002</span><span class="p">,</span> <span class="s1">'appid error'</span><span class="p">);</span>  <span class="c1">//appid为空或者错误
</span><span class="p">}</span>

                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$token_params</span><span class="p">[</span><span class="s1">'time'</span><span class="p">])){</span>
                    <span class="nx">echo_json</span><span class="p">(</span><span class="mi">1003</span><span class="p">,</span> <span class="s1">'time error'</span><span class="p">);</span>  <span class="c1">//time为空或者错误
</span><span class="p">}</span>

                    <span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nv">$token_params</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span> <span class="o">-</span> <span class="nb">time</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">){</span>    <span class="c1">// api 调用时间限制左右浮动10分钟
</span>    <span class="nx">echo_json</span><span class="p">(</span><span class="mi">1004</span><span class="p">,</span> <span class="s1">'time expired'</span><span class="p">);</span>  <span class="c1">// 10 minutes
</span><span class="p">}</span>

<span class="c1">//用appid取用户
</span><span class="nv">$user</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$users</span><span class="p">[</span><span class="nv">$token_params</span><span class="p">[</span><span class="s1">'appid'</span><span class="p">]])</span> <span class="o">?</span> <span class="nv">$users</span><span class="p">[</span><span class="nv">$token_params</span><span class="p">[</span><span class="s1">'appid'</span><span class="p">]]</span> <span class="o">:</span> <span class="p">[];</span>
                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$user</span><span class="p">)){</span>
                    <span class="nx">echo_json</span><span class="p">(</span><span class="mi">1005</span><span class="p">,</span> <span class="s1">'appid not exists'</span><span class="p">);</span>  <span class="c1">//调用方不存在
</span><span class="p">}</span>

<span class="c1">//使用调用方参数生成token
</span><span class="nv">$create_token</span> <span class="o">=</span> <span class="nx">generate_token</span><span class="p">(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">'appid'</span><span class="p">],</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'secret_key'</span><span class="p">],</span> <span class="nv">$token_params</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]);</span>

                    <span class="k">if</span><span class="p">(</span><span class="nv">$token</span> <span class="o">!==</span> <span class="nv">$create_token</span><span class="p">){</span>
                    <span class="nx">echo_json</span><span class="p">(</span><span class="mi">1006</span><span class="p">,</span> <span class="s1">'token error'</span><span class="p">);</span>  <span class="c1">//token错误
</span><span class="p">}</span>

<span class="c1">//到此 调用权限的验证就ok了
</span>
                    <span class="nv">$api</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'api'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'api'</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>

<span class="c1">//接下来你可以有其他对具体接口的验证...
</span>

<span class="c1">//返回结果
</span><span class="nx">echo_json</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s1">'your request api '</span><span class="o">.</span><span class="nv">$api</span><span class="o">.</span> <span class="s1">' success!'</span><span class="p">);</span>
                </code></pre>
                </div>

                <p>###api调用方
                    <code class="highlighter-rouge">use_api.php</code></p>
                <div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
                    <span class="k">require</span> <span class="s1">'api_functions.php'</span><span class="p">;</span>

<span class="c1">//假设使用方是 user_001 他拥有自己的appid和secret_key
</span><span class="nv">$user</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">'appid'</span> <span class="o">=&gt;</span> <span class="s1">'user_001'</span><span class="p">,</span>    <span class="c1">//使用方对于提供方api的唯一id
</span>    <span class="s1">'secret_key'</span> <span class="o">=&gt;</span> <span class="s1">'97bc847d4ea7dd9f035d41a657302f1c'</span>    <span class="c1">//密钥 也唯一
</span>
                    <span class="p">];</span>

<span class="c1">//生成token
</span><span class="nv">$token</span> <span class="o">=</span> <span class="nx">generate_token</span><span class="p">(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">'appid'</span><span class="p">],</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'secret_key'</span><span class="p">],</span> <span class="nb">time</span><span class="p">());</span>

<span class="c1">//url换成你自己的接口url
</span><span class="nv">$url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_HOST'</span><span class="p">]</span> <span class="o">.</span> <span class="nb">dirname</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">]);</span>

                    <span class="nv">$url</span> <span class="o">.=</span> <span class="s1">'/api.php?api=user_info'</span><span class="p">;</span> <span class="c1">//调用user_info的接口
</span><span class="nv">$url</span> <span class="o">.=</span> <span class="s1">'&amp;token='</span> <span class="o">.</span> <span class="nv">$token</span><span class="p">;</span>

                    <span class="k">echo</span> <span class="nv">$url</span><span class="p">;</span>
                    <span class="k">echo</span> <span class="s1">'&lt;hr&gt;&lt;pre&gt;'</span><span class="p">;</span>

<span class="c1">//请求接口
</span><span class="nv">$res</span> <span class="o">=</span> <span class="nx">sub_curl</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>

                    <span class="nb">var_dump</span><span class="p">(</span><span class="nb">json_decode</span><span class="p">(</span><span class="nv">$res</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

<span class="cm">/* 调用成功结果
array(3) {
  ["ret"]=&gt;
  int(200)
  ["msg"]=&gt;
  string(35) "your request api user_info success!"
  ["data"]=&gt;
  array(0) {
  }
}
*/</span>
                </code></pre>
                </div>

            </div>
        </div>

        <div class="right-side fl bbc">
            <div class="side-module">
                <div class="search-box">
                    <input type="text" name="kw" value="" class="search-kw" placeholder="来吧，输入你想找的">
                    <a href="" type="button"><i class="fa fa-search" aria-hidden="true"></i></a>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="footer">
    <p>
        Copyright ©2017 <a href="http://www.ioio.pw">满江风雪</a> <br>
        <a href="http://www.ioio.pw">www.ioio.pw</a>
    </p>
</div>

</body>
</html>